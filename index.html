<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <title>three.js webgl - Postprocessing - Unreal Bloom</title>
  <style>
    body { margin: 0; }
    #container { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/js/controls/OrbitControls.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/js/postprocessing/EffectComposer.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/js/postprocessing/RenderPass.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/js/postprocessing/UnrealBloomPass.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/js/postprocessing/OutputPass.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/js/libs/stats.module.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lil-gui/0.14.0/lil-gui.min.js"></script>

    let camera, scene, renderer, mixer, clock;
    let composer;
    let stats;
    let middleSection;

    const params = {
      threshold: 0.0,
      strength: 1.5,
      radius: 0.2,
      exposure: 1.0
    };

    init();

    async function init() {
      clock = new THREE.Clock();

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 100);
      camera.position.set(-5, 2.5, -3.5);
      scene.add(camera);

      scene.add(new THREE.AmbientLight(0xcccccc));

      const pointLight = new THREE.PointLight(0xffffff, 100);
      camera.add(pointLight);

      const loader = new GLTFLoader();
      const gltf = await loader.loadAsync('https://raw.githubusercontent.com/mailbennylim/webgl-gear/3b68fa4852e4d75578a374b6f4f1c6c5f4cd80f5/PrimaryIonDrive.glb');
      const model = gltf.scene;
      scene.add(model);

      // Find the middle section of the model (assuming it's named 'middle')
      middleSection = model.getObjectByName('middle');  // You can change 'middle' to the actual name of the part

      mixer = new THREE.AnimationMixer(model);
      const clip = gltf.animations[0];
      mixer.clipAction(clip.optimize()).play();

      // Set up renderer
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('container').appendChild(renderer.domElement);
      renderer.toneMapping = THREE.ReinhardToneMapping;

      // Post-processing setup
      const renderScene = new THREE.RenderPass(scene, camera);
      const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), params.strength, params.radius, params.threshold);
      const outputPass = new THREE.OutputPass();

      composer = new THREE.EffectComposer(renderer);
      composer.addPass(renderScene);
      composer.addPass(bloomPass);
      composer.addPass(outputPass);

      // Stats
      stats = new Stats();
      document.body.appendChild(stats.dom);

      // Orbit Controls
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.maxPolarAngle = Math.PI * 0.5;
      controls.minDistance = 3;
      controls.maxDistance = 8;

      // GUI for adjustments
      const gui = new GUI();
      const bloomFolder = gui.addFolder('Bloom');
      bloomFolder.add(params, 'threshold', 0.0, 1.0).onChange((value) => bloomPass.threshold = value);
      bloomFolder.add(params, 'strength', 0.0, 3.0).onChange((value) => bloomPass.strength = value);
      bloomFolder.add(params, 'radius', 0.0, 1.0).onChange((value) => bloomPass.radius = value);
      const toneMappingFolder = gui.addFolder('Tone Mapping');
      toneMappingFolder.add(params, 'exposure', 0.1, 2).onChange((value) => renderer.toneMappingExposure = Math.pow(value, 4.0));

      window.addEventListener('resize', onWindowResize);
      animate();
    }

    function onWindowResize() {
      const width = window.innerWidth;
      const height = window.innerHeight;

      camera.aspect = width / height;
      camera.updateProjectionMatrix();

      renderer.setSize(width, height);
      composer.setSize(width, height);
    }

    function animate() {
      const delta = clock.getDelta();
      mixer.update(delta);

      // Rotate the middle section
      if (middleSection) {
        middleSection.rotation.y += 0.01;  // Adjust the speed of rotation
      }

      stats.update();
      composer.render();
      requestAnimationFrame(animate);
    }
  </script>
</body>
</html>
